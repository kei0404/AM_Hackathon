# Feature Specification: Data Plug Copilot - パーソナルデータ駆動型カーパーソナライゼーションアプリ

**Feature Branch**: `001-navi-schedule`
**Created**: 2025-01-27
**Updated**: 2025-01-17
**Status**: Draft
**Version**: 2.3.0

## 概要

Data Plug Copilotは、ユーザーのパーソナルデータ（スケジュール、嗜好、移動履歴、お気に入りスポット）を分析し、AIが目的地を推薦・スケジュールを作成して、そのデータを「プラグイン」として車に接続することで、どの車でも「自分仕様」にパーソナライズできるアプリケーションです。

**コアバリュー**: 「車がその瞬間だけあなたのものになる」- ユーザーのデータはユーザーのデバイスに残り、車はセッション中のみそのデータにアクセスし、セッション終了時に車側のデータは消去される。

**プライバシー・バイ・デザイン原則**:
- ユーザーデータはユーザーのデバイス（ブラウザ/外部ストレージ）に保持
- 車は認可されたセッション中のみデータにアクセス
- セッション終了時に車側の全データを破棄

**プラットフォーム**: Webアプリケーション（ブラウザベース）
- モバイルネイティブアプリではなく、Webアプリとして開発
- MVP/デモでは「どんな情報を入力し、どんな情報が返されるか」を明確に表示するUIを重視

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - パーソナルデータからの目的地推薦 (Priority: P1)

ユーザーは自分の嗜好、過去の訪問履歴、お気に入りスポットなどのパーソナルデータを基に、AIから目的地の推薦を受けたいと考えています。「今日どこに行こうか」という曖昧な意図から、最大3回の質問で最適な目的地を絞り込みます。

**Why this priority**: これはアプリの核心機能です。ユーザーの意思決定をサポートし、パーソナライズされた提案を通じて移動体験を向上させます。

**Independent Test**: ユーザーがアプリに「どこかに行きたい」と伝え、AIが嗜好データを参照して候補を提示し、3回以内の質問で目的地を1つに絞り込めることを確認できます。

**Acceptance Scenarios**:

1. **Given** ユーザーのパーソナルデータに「カフェ好き」「静かな場所を好む」という嗜好が記録されている, **When** ユーザーが「今日どこか行きたい」と伝える, **Then** AIは「カフェに行きたいですか？それとも別のジャンルですか？」のように最大3回の質問で目的地を1つに絞り込む
2. **Given** ユーザーが過去に何度も訪問したお気に入りスポットがある, **When** ユーザーが「いつもの場所に行きたい」と伝える, **Then** AIはお気に入りスポットのリストを表示し、ユーザーが選択できるようにする
3. **Given** ユーザーが新しい場所を探している, **When** ユーザーが「新しいところを探して」と伝える, **Then** AIはユーザーの嗜好に基づいて未訪問のおすすめスポットを提案する

---

### User Story 2 - グループでの目的地合意形成 (Priority: P1)

複数の同乗者がいる場合、各自のスマートフォンから嗜好を収集し（2問の質問）、全員の希望を考慮した目的地候補を提示します。各候補について「誰のどの希望を満たすか」を説明し、グループでの合意形成をサポートします。

**Why this priority**: グループでの移動は日常的なシナリオであり、全員が納得できる目的地選びは重要な課題です。

**Independent Test**: 3人の同乗者がそれぞれスマートフォンで嗜好を入力し、AIが全員の希望を考慮した候補を「Aさんの○○、Bさんの△△を満たします」と説明付きで提示できることを確認できます。

**Acceptance Scenarios**:

1. **Given** 3人の同乗者がいる, **When** 各自がスマートフォンで2つの質問に回答する, **Then** AIは全員の回答を集約し、3つ以内の目的地候補を提示する
2. **Given** AIが目的地候補を提示している, **When** ユーザーが候補の詳細を確認する, **Then** 各候補について「Aさんの'静かな場所'、Bさんの'コーヒーが飲みたい'を満たします」のように説明する
3. **Given** 同乗者の希望が完全には一致しない, **When** AIが候補を提示する, **Then** 各候補がどの程度各自の希望を満たすかをスコアまたは説明で示す

---

### User Story 3 - AIによるスケジュール作成 (Priority: P1)

ユーザーは1日の予定（複数の目的地訪問）を効率的に組み立てたいと考えています。AIがパーソナルデータと各スポットの情報を基に、最適な訪問順序と時間配分を提案します。

**Why this priority**: 複数の予定がある日に効率的なスケジュールを立てることは、ユーザーの時間を節約し、移動体験を向上させます。

**Independent Test**: ユーザーが3つの目的地を指定し、AIが移動時間・営業時間・混雑状況を考慮した最適なスケジュールを提案できることを確認できます。

**Acceptance Scenarios**:

1. **Given** ユーザーが本日訪問したい3つの場所をリストしている, **When** ユーザーが「スケジュールを組んで」と依頼する, **Then** AIは移動時間と各スポットの営業時間を考慮した訪問順序と出発時刻を提案する
2. **Given** AIがスケジュールを提案している, **When** ユーザーが「午後は空けておきたい」と追加条件を伝える, **Then** AIはスケジュールを調整し、午後の予定を午前に移動させた新しい案を提示する
3. **Given** スケジュールに含まれるスポットの1つが予想より混雑している, **When** ユーザーがその場所に到着する, **Then** アプリはスケジュールの遅延リスクを通知し、調整オプションを提示する

---

### User Story 4 - 車へのデータプラグイン（セッション開始） (Priority: P1)

ユーザーは車に乗り込む際、自分のパーソナルデータを車に「プラグイン」して、車を自分仕様にパーソナライズしたいと考えています。QRコードまたは近接通信でセッションを開始し、車のナビにデータを連携します。

**Why this priority**: これがData Plugの核心概念です。どの車でも「自分の車」のように使える体験を実現します。

**Independent Test**: ユーザーがQRコードをスキャンして車とセッションを開始し、自分のスケジュールと目的地が車のナビに表示されることを確認できます。

**Acceptance Scenarios**:

1. **Given** ユーザーがアプリでスケジュールを作成済み, **When** ユーザーが車内のQRコードをスキャンする, **Then** セッションが開始され、ユーザーのスケジュールと目的地情報が車のナビに連携される
2. **Given** セッションが開始されている, **When** ユーザーがアプリで新しい目的地を追加する, **Then** 車のナビにもリアルタイムで反映される
3. **Given** ユーザーがセッションを開始しようとしている, **When** ユーザーがデータ共有範囲を選択する, **Then** 「スケジュールのみ」「お気に入りも含む」「全データ」などの選択肢が表示され、ユーザーが明示的に選択できる

---

### User Story 5 - セッション終了とデータ消去 (Priority: P1)

ユーザーは車を降りる際、車側に残ったデータが完全に消去されることを確認したいと考えています。セッション終了時に車側の全データが破棄され、プライバシーが保護されます。

**Why this priority**: プライバシー・バイ・デザインの核心要件です。ユーザーは安心してデータを共有できます。

**Independent Test**: セッションを終了し、車側にユーザーデータが残っていないことを確認できます。

**Acceptance Scenarios**:

1. **Given** セッションが開始されている, **When** ユーザーがアプリで「セッション終了」を選択する, **Then** 車側の全ユーザーデータが消去され、消去完了の通知がユーザーに表示される
2. **Given** ユーザーがセッション終了を忘れた, **When** 車のエンジンが停止してから一定時間（例：5分）が経過する, **Then** 自動的にセッションが終了し、データが消去される
3. **Given** セッションが終了した, **When** 次のユーザーが同じ車を使用する, **Then** 前のユーザーのデータは一切残っておらず、完全にリセットされた状態になる

---

### User Story 6 - パーソナルデータの管理と蓄積 (Priority: P2)

ユーザーは自分のパーソナルデータ（嗜好、お気に入りスポット、訪問履歴）を管理し、時間とともに蓄積・更新したいと考えています。

**Why this priority**: パーソナライズの精度はデータの蓄積によって向上します。ユーザーが自分のデータを管理できることも重要です。

**Independent Test**: ユーザーがお気に入りスポットを追加・編集・削除でき、その変更が次回の推薦に反映されることを確認できます。

**Acceptance Scenarios**:

1. **Given** ユーザーが新しい場所を訪問した, **When** ユーザーがその場所を「お気に入り」に追加する, **Then** その場所がパーソナルデータに保存され、次回の推薦候補に含まれる
2. **Given** ユーザーが嗜好を変更したい, **When** ユーザーが設定画面で「静かな場所を好む」から「賑やかな場所を好む」に変更する, **Then** 次回の推薦がその嗜好を反映したものになる
3. **Given** ユーザーが訪問履歴を確認したい, **When** ユーザーが履歴画面を開く, **Then** 過去の訪問先、訪問日時、滞在時間が表示される

---

### User Story 7 - データポータビリティ（車両間でのデータ移行） (Priority: P2)

ユーザーはレンタカー、カーシェア、友人の車など、異なる車両でも同じパーソナライズ体験を得たいと考えています。データはユーザーのデバイスに保持されているため、どの車でもプラグインするだけで同じ体験が可能です。

**Why this priority**: Data Plugの「ポータビリティ」を実現する重要な機能です。

**Independent Test**: ユーザーが車Aでセッションを終了し、車Bで新しいセッションを開始した際、同じパーソナルデータが利用できることを確認できます。

**Acceptance Scenarios**:

1. **Given** ユーザーが車Aでセッションを使用した, **When** ユーザーが車Bで新しいセッションを開始する, **Then** ユーザーの全パーソナルデータが車Bでも利用可能になる
2. **Given** ユーザーが車Aで新しいお気に入りを追加した, **When** セッション終了後に車Bでセッションを開始する, **Then** 車Aで追加したお気に入りも車Bで利用可能になる

---

### Edge Cases

- ユーザーがパーソナルデータへのアクセス権限を拒否した場合、アプリはどのように動作するか？
- 車との接続が途中で切断された場合、セッションはどのように処理されるか？
- 複数のユーザーが同時に同じ車にプラグインしようとした場合、どのように処理されるか？
- ユーザーがオフラインの場合、目的地推薦やスケジュール作成はどのように動作するか？
- 推薦された目的地が営業時間外または休業日だった場合、どのように通知されるか？
- グループ合意形成で同乗者の一部がスマートフォンを持っていない場合、どのように対応するか？
- セッション中にユーザーのスマートフォンのバッテリーが切れた場合、車側のデータはどうなるか？
- ユーザーがデータ消去を確認したい場合、どのように検証できるか？

---

## Requirements *(mandatory)*

### Functional Requirements

#### パーソナルデータ管理

- **FR-001**: システムはユーザーのパーソナルデータ（嗜好、お気に入りスポット、訪問履歴）をユーザーのデバイスに保存できなければならない
- **FR-002**: ユーザーは自分のパーソナルデータを閲覧、追加、編集、削除できなければならない
- **FR-003**: システムは訪問履歴を自動的に記録し、パーソナルデータに追加できなければならない
- **FR-004**: ユーザーは嗜好設定（好みのジャンル、雰囲気、価格帯など）を設定・変更できなければならない

#### 目的地推薦

- **FR-005**: AIはユーザーのパーソナルデータを分析し、目的地候補を推薦できなければならない
- **FR-006**: AIは最大3回の質問でユーザーの意図を明確化し、単一の目的地に絞り込めなければならない
- **FR-007**: AIはユーザーの嗜好に基づいて、未訪問のおすすめスポットを提案できなければならない
- **FR-008**: システムは推薦の根拠（なぜこの場所を推薦したか）を説明できなければならない

#### グループ合意形成

- **FR-009**: システムは複数の同乗者からスマートフォン経由で嗜好情報を収集できなければならない（2問の質問）
- **FR-010**: AIは全同乗者の嗜好を考慮した目的地候補を生成し、各候補がどの希望を満たすかを説明できなければならない
- **FR-011**: システムは同乗者ごとの満足度スコアまたは説明を提示できなければならない

#### スケジュール作成

- **FR-012**: AIは複数の目的地に対して、移動時間・営業時間を考慮した最適な訪問順序を提案できなければならない
- **FR-013**: ユーザーはスケジュールに対して追加条件（時間制約など）を指定でき、AIがそれを考慮して再提案できなければならない
- **FR-014**: システムはスケジュールの遅延リスクを検知し、ユーザーに通知できなければならない

#### 車へのプラグイン（セッション管理）

- **FR-015**: ユーザーはQRコードまたは近接通信で車とのセッションを開始できなければならない
- **FR-016**: セッション開始時にユーザーはデータ共有範囲を明示的に選択できなければならない
- **FR-017**: セッション中はユーザーのスケジュールと目的地情報が車のナビに連携されなければならない
- **FR-018**: ユーザーはいつでもセッションを終了できなければならない
- **FR-019**: セッション終了時に車側の全ユーザーデータが消去されなければならない
- **FR-020**: 車のエンジン停止後一定時間経過でセッションが自動終了しなければならない

#### プライバシー・セキュリティ

- **FR-021**: パーソナルデータはユーザーのデバイスにのみ保存され、外部サーバーには送信されないこと
- **FR-022**: 車側でのデータアクセスはセッション中のみに限定されること
- **FR-023**: ユーザーはいつでも全パーソナルデータを削除できなければならない
- **FR-024**: データ消去が完了したことをユーザーが確認できなければならない

#### 運転中の安全配慮

- **FR-025**: 運転中のAIからの提案は「はい/いいえ」または3つ以内の選択肢で応答できる形式で表示されなければならない
- **FR-026**: ユーザーは音声でAIに指示を出すことができなければならない

---

### Key Entities *(include if feature involves data)*

- **パーソナルデータ**: ユーザーの嗜好、お気に入り、履歴を含む個人データの集合
  - 属性：ユーザーID、嗜好設定、お気に入りスポットリスト、訪問履歴、作成日時、更新日時

- **嗜好設定**: ユーザーの好みを定義する設定
  - 属性：好みのジャンル（カフェ、レストラン、自然など）、雰囲気（静か、賑やか）、価格帯、その他のカスタム設定

- **お気に入りスポット**: ユーザーが明示的に保存した場所
  - 属性：場所名、住所、緯度経度、カテゴリ、ユーザーメモ、追加日時

- **訪問履歴**: ユーザーが過去に訪問した場所の記録
  - 属性：場所情報、訪問日時、滞在時間、訪問回数

- **スケジュール**: AIが作成した1日の行動計画
  - 属性：日付、目的地リスト（順序付き）、各目的地の予定到着時刻・滞在時間、移動時間

- **セッション**: ユーザーと車の間のデータ共有接続
  - 属性：セッションID、ユーザーID、車両ID、開始日時、共有範囲、ステータス（アクティブ/終了）

- **目的地推薦**: AIが生成した推薦結果
  - 属性：推薦候補リスト、各候補の推薦理由、マッチ度スコア

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

#### 目的地推薦

- **SC-001**: ユーザーは曖昧な意図（「どこか行きたい」）から最大3回の質問で単一の目的地に到達できる
- **SC-002**: AIの推薦に対してユーザーの80%が「自分の好みに合っている」と評価する
- **SC-003**: 未訪問スポットの推薦のうち、90%が実際にユーザーの嗜好カテゴリに合致している

#### グループ合意形成

- **SC-004**: 同乗者全員が嗜好入力を完了するまでの時間が1人あたり30秒以内である
- **SC-005**: グループでの目的地決定において、75%のケースで全員が「納得できる」と回答する
- **SC-006**: AIの説明（誰のどの希望を満たすか）を理解したユーザーの90%が「分かりやすい」と評価する

#### スケジュール作成

- **SC-007**: AIが作成したスケジュールの95%で、各スポットの営業時間内に到着できる
- **SC-008**: スケジュール調整の追加条件入力から新しい案の提示まで10秒以内である
- **SC-009**: スケジュール通りに行動できたケースが80%以上である

#### 車へのプラグイン

- **SC-010**: セッション開始（QRスキャンからナビ連携完了まで）が15秒以内に完了する
- **SC-011**: セッション終了からデータ消去完了までが5秒以内である
- **SC-012**: 車両を乗り換えた場合でも、新しいセッション開始から同じデータが利用可能になるまで15秒以内である

#### 全体的なユーザー体験

- **SC-013**: 運転中のAI操作は音声または片手で3秒以内に完了できる
- **SC-014**: アプリを使用したユーザーの85%が「また使いたい」と回答する

---

## Technical Constraints *(project decision)*

以下の技術スタックはプロジェクトの意思決定として定められています：

### プラットフォーム
- **種別**: Webアプリケーション（ブラウザベース）
- **対象**: デスクトップブラウザ優先（モバイルネイティブアプリは開発しない）

### バックエンド & フロントエンド（統合）
- **フレームワーク**: FastAPI
- **言語**: Python
- **用途**: REST API、LLM連携、セッション管理、ビジネスロジック、**HTML UI配信**
- **UI実装**: FastAPIのJinja2テンプレート + HTMLによるサーバーサイドレンダリング

### MVP/デモ UI方針
- **重視点**: 「どんな情報を受け取り、どんな情報を返しているか」が明確にわかること
- **目的**: データフローの可視化、API入出力の確認、デモンストレーション
- **非重視**: 洗練されたビジュアルデザイン、モバイル最適化、SPA（Single Page Application）

### 選定理由
- FastAPI: 高速な非同期処理、自動APIドキュメント生成、型安全性、LLM APIとの親和性
- Jinja2テンプレート: Python統一環境、シンプルなHTML生成、学習コスト低減

---

## Assumptions

- ユーザーはWebブラウザが利用可能なデバイス（PC、タブレット、スマートフォン）を持っている
- MVPではWebアプリとして動作し、ネイティブモバイルアプリは開発しない
- 車との接続はQRコードをシミュレートした論理的なセッション開始で代替（物理デバイス不要）
- 車のナビゲーションシステム連携はMVPでは擬似的なWeb UI画面で表現
- ユーザーはインターネット接続が利用可能な環境で使用する
- AIエージェントはクラウドのLLM（Qwen等）を使用する
- ユーザーのパーソナルデータはブラウザのローカルストレージまたはセッションストレージに保存
- グループ合意形成機能では同乗者も同じWebアプリにアクセスできることを前提とする

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更理由 |
|------|------------|----------|----------|
| 2025-01-27 | 1.0.0 | 初版作成 | 初期要件定義 |
| 2025-01-17 | 1.1.0 | PRD「Data Plug Copilot」の情報を統合 | ハッカソン製品ビジョンとの整合性確保 |
| 2025-01-17 | 2.0.0 | パーソナルデータ駆動型の仕様にリファクタリング | ユーザー指示：パーソナルデータからの目的地推薦・スケジュール作成・車へのプラグインに焦点 |
| 2025-01-17 | 2.1.0 | 技術制約セクションを追加（FastAPI、Next.js） | プロジェクトの技術スタック決定を明示化 |
| 2025-01-17 | 2.2.0 | Webアプリ開発に方針変更、MVP UI方針を明確化 | モバイルネイティブではなくWebアプリとして開発、UIはデータフロー可視化を重視 |
| 2025-01-17 | 2.3.0 | フロントエンドもFastAPIで統合開発に変更 | Next.js → FastAPI + Jinja2テンプレートに変更、Python統一環境 |

### v2.3.0の主な変更点

**技術スタックの統合**:
- フロントエンド: Next.js → **FastAPI + Jinja2テンプレート**
- バックエンドとフロントエンドを**Python/FastAPIで統一**
- サーバーサイドレンダリング（SSR）によるHTML配信

**メリット**:
- 言語・フレームワークの統一によるシンプルな開発環境
- 学習コストの低減
- デプロイ・運用の簡素化

**削除**:
- Next.js（TypeScript/JavaScript）の使用

---

### v2.2.0の主な変更点

**プラットフォーム方針の変更**:
- モバイルネイティブアプリ → **Webアプリケーション**（ブラウザベース）
- デスクトップブラウザ優先の開発

**MVP/デモ UI方針の追加**:
- 「どんな情報を受け取り、どんな情報を返しているか」がわかるUIを重視
- データフローの可視化、API入出力の確認が目的
- 洗練されたビジュアルデザインやモバイル最適化は非重視

**Assumptionsの更新**:
- スマートフォンアプリ前提 → Webブラウザ利用前提
- ローカルストレージ → ブラウザのストレージ
- 車との物理接続 → 論理的なセッションでシミュレート

---

### v2.1.0の主な変更点

**追加**:
- Technical Constraintsセクション: プロジェクトの技術スタック決定を文書化
  - バックエンド: FastAPI（Python）
  - フロントエンド: Next.js（TypeScript/JavaScript）← v2.3.0でFastAPIに変更
  - 選定理由の説明

---

### v2.0.0の主な変更点

**コンセプトの明確化**:
- 「パーソナルデータ」「目的地推薦」「スケジュール作成」「車へのプラグイン」という4つの柱に再構成
- プライバシー・バイ・デザイン原則を明示化（セッションベースのデータアクセス、終了時のデータ消去）

**追加**:
- US1: パーソナルデータからの目的地推薦（最大3回の質問で絞り込み）
- US2: グループでの目的地合意形成（同乗者の嗜好収集と説明付き提案）
- US3: AIによるスケジュール作成
- US4: 車へのデータプラグイン（セッション開始）
- US5: セッション終了とデータ消去
- US6: パーソナルデータの管理と蓄積
- US7: データポータビリティ

**削除**:
- 旧US4: AIエージェントによるスポット提案（Trend Stock機能）- SNSトレンドからパーソナルデータ中心に変更
- 旧US6: ドライバーと乗客の会話ファシリテーション - タクシードライバー向け機能を削除

**変更**:
- ターゲットユーザーを一般ドライバー（個人）に焦点化
- Trend Stock（SNS外部データ）を削除し、ユーザーのパーソナルデータのみに焦点化
- Key EntitiesをData Plug中心のエンティティに再構成

**バックアップ**:
- 旧バージョン（v1.1.0）は `docs/requirements/spec_v1.1.0_backup.md` に保存
