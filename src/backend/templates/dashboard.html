{% extends "base.html" %}

{% block title %}Data Plug Copilot - Data Flow Dashboard{% endblock %}

{% block content %}
<!-- Data Flow Overview Banner -->
<div class="mb-6 p-4 bg-gradient-to-r from-blue-500/10 via-violet-500/10 to-emerald-500/10 rounded-2xl border border-slate-700">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <div class="p-2 bg-blue-500/20 rounded-lg">
                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </div>
            <div>
                <h2 class="font-semibold">Data Flow Visualization</h2>
                <p class="text-sm text-slate-400">LLMへの入力データと出力データをリアルタイムで確認</p>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <div class="flex items-center space-x-2 text-sm">
                <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                <span class="text-slate-400">Input</span>
            </div>
            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
            </svg>
            <div class="flex items-center space-x-2 text-sm">
                <span class="w-3 h-3 bg-emerald-500 rounded-full"></span>
                <span class="text-slate-400">Output</span>
            </div>
            <div class="ml-4 px-3 py-1 bg-slate-700 rounded-lg text-sm">
                <span class="text-slate-400">Session:</span>
                <span id="session-id-display" class="text-blue-400 mono ml-1">{% if session_id %}{{ session_id[:8] }}...{% else %}未開始{% endif %}</span>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- INPUT PANEL -->
    <section class="space-y-4">
        <div class="flex items-center space-x-3">
            <div class="p-2 bg-blue-500/20 rounded-lg">
                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                </svg>
            </div>
            <h2 class="text-lg font-semibold text-blue-400">INPUT - LLMへ送信するデータ</h2>
        </div>

        <!-- User Visit History Data -->
        <div class="data-panel rounded-xl border border-slate-700 overflow-hidden">
            <div class="px-4 py-3 bg-slate-800/50 border-b border-slate-700 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span class="w-2 h-2 bg-blue-400 rounded-full"></span>
                    <span class="font-medium text-sm">user_data</span>
                </div>
                <span id="user-data-count" class="text-xs text-slate-500 mono">{% if session_started %}{{ user_data.total_count }} records{% else %}-- records{% endif %}</span>
            </div>
            <div class="p-4 mono text-sm max-h-64 overflow-y-auto">
                <pre id="user-data-json" class="whitespace-pre-wrap">{% if session_started %}<span class="json-key">{</span>
  <span class="json-key">"total_count"</span>: <span class="json-number">{{ user_data.total_count }}</span>,
  <span class="json-key">"records"</span>: <span class="json-key">[</span>{% for record in user_data.records %}
    <span class="json-key">{</span>
      <span class="json-key">"id"</span>: <span class="json-string">"{{ record.id }}"</span>,
      <span class="json-key">"datetime"</span>: <span class="json-string">"{{ record.datetime }}"</span>,
      <span class="json-key">"place_name"</span>: <span class="json-string">"{{ record.place_name }}"</span>,
      <span class="json-key">"address"</span>: <span class="json-string">"{{ record.address }}"</span>,
      <span class="json-key">"impression"</span>: <span class="json-string">"{{ record.impression }}"</span>
    <span class="json-key">}</span>{% if not loop.last %},{% endif %}{% endfor %}
  <span class="json-key">]</span>
<span class="json-key">}</span>{% else %}<span class="text-slate-500">// セッション開始後にデータが表示されます</span>{% endif %}</pre>
            </div>
        </div>

        <!-- User Message Input -->
        <div id="input-panel" class="data-panel rounded-xl border-2 border-blue-500/50 overflow-hidden {% if not session_started %}opacity-50{% endif %}">
            <div class="px-4 py-3 bg-blue-500/10 border-b border-slate-700 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span id="input-status-dot" class="w-2 h-2 bg-blue-400 rounded-full {% if session_started %}animate-pulse{% endif %}"></span>
                    <span class="font-medium text-sm text-blue-300">user_message</span>
                </div>
                <span class="text-xs text-blue-400 mono">{% if session_started %}Current Input{% else %}待機中{% endif %}</span>
            </div>
            <div id="input-json" class="p-4 mono text-sm">
                <pre id="input-json-content" class="whitespace-pre-wrap">{% if session_started %}<span class="json-key">{</span>
  <span class="json-key">"message"</span>: <span class="json-string" id="input-message-display">""</span>,
  <span class="json-key">"session_id"</span>: <span class="json-string">"{{ session_id }}"</span>,
  <span class="json-key">"turn_count"</span>: <span class="json-number" id="input-turn-display">{{ turn_count }}</span>
<span class="json-key">}</span>{% else %}<span class="text-slate-500">// セッション開始後に入力データが表示されます</span>{% endif %}</pre>
            </div>
        </div>

        <!-- Route Input (現在地・目的地) -->
        <div id="route-panel" class="bg-slate-800 rounded-xl p-4 border border-slate-700 mb-4 {% if not session_started %}opacity-50{% endif %}">
            <div class="flex items-center space-x-2 mb-3">
                <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                </svg>
                <span class="text-sm font-medium text-slate-300">ルート設定</span>
                <span id="route-status" class="text-xs text-slate-500 ml-2">{% if not session_started %}(セッション開始後に入力可能){% endif %}</span>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-slate-500 mb-1 block">現在地</label>
                    <input type="text"
                           id="current-location"
                           class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-400 focus:outline-none focus:border-emerald-500 disabled:opacity-50"
                           placeholder="例: 東京駅"
                           value=""
                           {% if not session_started %}disabled{% endif %}>
                </div>
                <div>
                    <label class="text-xs text-slate-500 mb-1 block">目的地</label>
                    <input type="text"
                           id="destination"
                           class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-400 focus:outline-none focus:border-emerald-500 disabled:opacity-50"
                           placeholder="例: 横浜駅"
                           value=""
                           {% if not session_started %}disabled{% endif %}>
                </div>
            </div>
        </div>

        <!-- Voice Transcription Display -->
        <div id="transcription-panel" class="bg-slate-800 rounded-xl p-4 border border-slate-700 mb-4 hidden">
            <div class="flex items-center space-x-2 mb-2">
                <svg class="w-4 h-4 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                </svg>
                <span class="text-sm font-medium text-violet-300">音声認識中...</span>
                <span id="asr-status" class="text-xs text-slate-500 ml-auto">待機中</span>
            </div>
            <div id="transcription-text" class="text-sm text-slate-300 min-h-[40px] p-2 bg-slate-700/50 rounded-lg">
                <span class="text-slate-500">音声を入力してください...</span>
            </div>
        </div>

        <!-- Chat Input UI -->
        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
            <form id="chat-form">
                <input type="text"
                       id="message-input"
                       name="message"
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 disabled:opacity-50"
                       placeholder="{% if session_started %}メッセージを入力してEnterで送信...{% else %}Startボタンを押してセッションを開始してください{% endif %}"
                       autocomplete="off"
                       {% if not session_started %}disabled{% endif %}>
            </form>

            <!-- Start / Stop / Recording Buttons -->
            <div class="flex items-center justify-center space-x-4 mt-4 pt-4 border-t border-slate-700">
                <button id="start-button"
                        class="flex items-center space-x-2 px-6 py-2 bg-emerald-500 hover:bg-emerald-600 rounded-lg transition-colors text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Start</span>
                </button>
                <button id="stop-button"
                        class="flex items-center space-x-2 px-6 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-colors text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                    </svg>
                    <span>Stop</span>
                </button>
                <!-- Recording Toggle Button -->
                <button id="recording-button"
                        class="flex items-center space-x-2 px-6 py-2 bg-violet-500 hover:bg-violet-600 rounded-lg transition-colors text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    <svg id="mic-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                    <span id="recording-button-text">録音開始</span>
                </button>
            </div>

            <div id="quick-replies" class="flex flex-wrap gap-2 mt-3">
                <span class="text-xs text-slate-500">Quick:</span>
                {% for suggestion in suggestions %}
                <button class="quick-reply px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-full text-xs text-slate-300 transition-colors">
                    {{ suggestion }}
                </button>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- OUTPUT PANEL -->
    <section class="space-y-4">
        <div class="flex items-center space-x-3">
            <div class="p-2 bg-emerald-500/20 rounded-lg">
                <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <h2 class="text-lg font-semibold text-emerald-400">OUTPUT - LLMからの応答</h2>
        </div>

        <!-- LLM Response Data -->
        <div id="output-panel" class="data-panel rounded-xl border-2 border-emerald-500/50 overflow-hidden">
            <div class="px-4 py-3 bg-emerald-500/10 border-b border-slate-700 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span id="output-status-dot" class="w-2 h-2 bg-emerald-400 rounded-full"></span>
                    <span class="font-medium text-sm text-emerald-300">llm_response</span>
                </div>
                <span id="output-status" class="text-xs text-emerald-400 mono">{% if session_started %}Waiting...{% else %}待機中{% endif %}</span>
            </div>
            <div id="output-json" class="p-4 mono text-sm max-h-64 overflow-y-auto">
                <pre id="output-json-content" class="whitespace-pre-wrap">{% if session_started %}<span class="json-key">{</span>
  <span class="json-key">"message"</span>: <span class="json-string">"{{ welcome_message | replace('\n', '\\n') }}"</span>,
  <span class="json-key">"suggestions"</span>: [{% for s in suggestions %}<span class="json-string">"{{ s }}"</span>{% if not loop.last %}, {% endif %}{% endfor %}],
  <span class="json-key">"turn_count"</span>: <span class="json-number">{{ turn_count }}</span>,
  <span class="json-key">"is_complete"</span>: <span class="json-boolean">{{ 'true' if is_complete else 'false' }}</span>
<span class="json-key">}</span>{% else %}<span class="text-slate-500">// 待機中</span>{% endif %}</pre>
            </div>
        </div>

        <!-- Rendered Chat Response -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
            <div class="px-4 py-3 bg-slate-800/50 border-b border-slate-700 flex items-center justify-between">
                <span class="text-sm font-medium text-slate-400">Rendered UI</span>
                <span id="progress-indicator" class="text-xs text-slate-500">質問 {{ turn_count }}/{{ max_turns }}</span>
            </div>
            <div id="chat-container" class="p-4 space-y-4 max-h-80 overflow-y-auto">
                {% if session_started %}
                <!-- AI Welcome Message -->
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-violet-500 to-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="bg-slate-700 rounded-2xl rounded-tl-none p-4">
                            <p id="ai-message" class="text-sm text-slate-200 whitespace-pre-line">{{ welcome_message }}</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Waiting state -->
                <div class="flex items-center justify-center py-8">
                    <div class="text-center">
                        <div class="w-12 h-12 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        <p class="text-slate-500 text-sm">待機中</p>
                        <p class="text-slate-600 text-xs mt-1">Startボタンを押してセッションを開始してください</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Session Info -->
        <div class="data-panel rounded-xl border border-slate-700 overflow-hidden">
            <div class="px-4 py-3 bg-slate-800/50 border-b border-slate-700 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span class="w-2 h-2 bg-amber-400 rounded-full"></span>
                    <span class="font-medium text-sm">session_state</span>
                </div>
                <span class="text-xs text-slate-500 mono">Metadata</span>
            </div>
            <div class="p-4 mono text-sm">
                <pre id="session-state-json" class="whitespace-pre-wrap">{% if session_started %}<span class="json-key">{</span>
  <span class="json-key">"session_id"</span>: <span class="json-string">"{{ session_id }}"</span>,
  <span class="json-key">"status"</span>: <span class="json-string" id="session-status">"active"</span>,
  <span class="json-key">"turn_count"</span>: <span class="json-number" id="session-turn">{{ turn_count }}</span>,
  <span class="json-key">"max_turns"</span>: <span class="json-number">{{ max_turns }}</span>,
  <span class="json-key">"data_scope"</span>: [<span class="json-string">"preferences"</span>, <span class="json-string">"favorites"</span>]
<span class="json-key">}</span>{% else %}<span class="text-slate-500">// 待機中</span>
<span id="session-status" style="display:none">"waiting"</span>
<span id="session-turn" style="display:none">0</span>{% endif %}</pre>
            </div>
        </div>
    </section>
</div>

<!-- API Call Log -->
<section class="mt-8">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
            <div class="p-2 bg-amber-500/20 rounded-lg">
                <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
            </div>
            <h2 class="text-lg font-semibold text-amber-400">API Call Log</h2>
        </div>
        <button id="clear-log" class="text-sm text-slate-400 hover:text-white transition-colors">Clear Log</button>
    </div>

    <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
        <div id="api-log" class="divide-y divide-slate-700 max-h-48 overflow-y-auto">
            <div class="p-4 text-sm text-slate-500 text-center">
                API呼び出しログがここに表示されます
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    let sessionId = "{{ session_id }}";
    let turnCount = {{ turn_count }};
    const maxTurns = {{ max_turns }};

    // DOM elements
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatContainer = document.getElementById('chat-container');
    const apiLog = document.getElementById('api-log');
    const outputJsonContent = document.getElementById('output-json-content');
    const outputStatus = document.getElementById('output-status');
    const outputStatusDot = document.getElementById('output-status-dot');
    const progressIndicator = document.getElementById('progress-indicator');
    const sessionTurn = document.getElementById('session-turn');
    const startButton = document.getElementById('start-button');
    const stopButton = document.getElementById('stop-button');
    const currentLocationInput = document.getElementById('current-location');
    const destinationInput = document.getElementById('destination');

    // Voice input DOM elements
    const recordingButton = document.getElementById('recording-button');
    const recordingButtonText = document.getElementById('recording-button-text');
    const micIcon = document.getElementById('mic-icon');
    const transcriptionPanel = document.getElementById('transcription-panel');
    const transcriptionText = document.getElementById('transcription-text');
    const asrStatus = document.getElementById('asr-status');

    // Session state
    let isSessionActive = {{ 'true' if session_started else 'false' }};
    let conversationPhase = 'waiting_start';  // waiting_start, waiting_location, asking_destination, asking_preferences, suggesting

    // Start button - Create new session
    startButton.addEventListener('click', async () => {
        startButton.disabled = true;
        const startTime = Date.now();

        try {
            const response = await fetch('/api/v1/chat/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({}),
            });

            const duration = Date.now() - startTime;

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            sessionId = data.session_id;
            isSessionActive = true;
            conversationPhase = 'waiting_location';

            // Update UI elements
            document.getElementById('session-id-display').textContent = sessionId.substring(0, 8) + '...';

            // Update session_state display
            const sessionStateJson = document.getElementById('session-state-json');
            sessionStateJson.innerHTML = `<span class="json-key">{</span>
  <span class="json-key">"session_id"</span>: <span class="json-string">"${sessionId}"</span>,
  <span class="json-key">"status"</span>: <span class="json-string" id="session-status">"active"</span>,
  <span class="json-key">"turn_count"</span>: <span class="json-number" id="session-turn">0</span>,
  <span class="json-key">"max_turns"</span>: <span class="json-number">${maxTurns}</span>,
  <span class="json-key">"data_scope"</span>: [<span class="json-string">"preferences"</span>, <span class="json-string">"favorites"</span>]
<span class="json-key">}</span>`;

            // Enable route inputs (message input stays disabled until preferences phase)
            messageInput.disabled = true;
            messageInput.placeholder = '現在地と目的地を入力後に使用できます';
            currentLocationInput.disabled = false;
            destinationInput.disabled = true;  // Will be enabled after current location is entered

            // Focus on current location input
            currentLocationInput.focus();

            // Update panels
            document.getElementById('input-panel').classList.remove('opacity-50');
            document.getElementById('input-status-dot').classList.add('animate-pulse');
            document.getElementById('route-panel').classList.remove('opacity-50');
            document.getElementById('route-status').textContent = '';

            // Fetch and display user_data
            await fetchAndDisplayUserData();

            // Update input JSON display
            updateInputJsonDisplay('', sessionId, 0);

            // Update output with welcome message
            updateOutputJson(data);
            outputStatus.textContent = '200 OK';

            // Add welcome message to chat
            addMessage('assistant', data.message, data.suggestions);

            // Log API call
            logApiCall('POST', '/api/v1/chat/start', response.status, duration);

            // Enable recording button
            console.log('Enabling recording button...', recordingButton);
            if (recordingButton) {
                recordingButton.disabled = false;
                recordingButton.removeAttribute('disabled');
                console.log('Recording button enabled:', !recordingButton.disabled);
            } else {
                console.error('Recording button not found!');
            }

        } catch (error) {
            console.error('Error starting session:', error);
            alert('セッションの開始に失敗しました');
        } finally {
            startButton.disabled = false;
        }
    });

    // Fetch user data and display
    async function fetchAndDisplayUserData() {
        try {
            const response = await fetch('/api/v1/chat/debug/vector-store');
            if (response.ok) {
                const data = await response.json();

                // Update user_data display (simplified for now)
                document.getElementById('user-data-count').textContent = `${data.document_count} records`;
                document.getElementById('user-data-json').innerHTML = `<span class="json-key">{</span>
  <span class="json-key">"total_count"</span>: <span class="json-number">${data.document_count}</span>,
  <span class="json-key">"collection"</span>: <span class="json-string">"${data.collection_name}"</span>,
  <span class="json-key">"persist_dir"</span>: <span class="json-string">"${data.persist_dir}"</span>
<span class="json-key">}</span>`;
            }
        } catch (error) {
            console.error('Error fetching user data:', error);
        }
    }

    // Update input JSON display
    function updateInputJsonDisplay(message, sid, turn) {
        const inputJsonContent = document.getElementById('input-json-content');
        inputJsonContent.innerHTML = `<span class="json-key">{</span>
  <span class="json-key">"message"</span>: <span class="json-string">"${escapeHtml(message)}"</span>,
  <span class="json-key">"session_id"</span>: <span class="json-string">"${sid}"</span>,
  <span class="json-key">"turn_count"</span>: <span class="json-number">${turn}</span>
<span class="json-key">}</span>`;
    }

    // Stop button - End current session
    stopButton.addEventListener('click', async () => {
        if (!confirm('セッションを終了しますか？会話履歴は削除されます。')) {
            return;
        }

        stopButton.disabled = true;

        try {
            const response = await fetch(`/api/v1/chat/session/${sessionId}`, {
                method: 'DELETE',
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Log API call
            logApiCall('DELETE', `/api/v1/chat/session/${sessionId}`, response.status, 0);

            // Reset all UI to initial state
            resetUIToInitialState();

        } catch (error) {
            console.error('Error stopping session:', error);
            alert('セッションの終了に失敗しました');
        } finally {
            stopButton.disabled = false;
        }
    });

    // Reset all UI elements to initial (waiting) state
    function resetUIToInitialState() {
        // Reset session state
        isSessionActive = false;
        conversationPhase = 'waiting_start';
        sessionId = '';
        turnCount = 0;

        // Reset session display
        document.getElementById('session-id-display').textContent = '待機中';

        // Reset user_data widget
        document.getElementById('user-data-count').textContent = '-- records';
        document.getElementById('user-data-json').innerHTML = '<span class="text-slate-500">// 待機中 - Startボタンを押してセッションを開始してください</span>';

        // Reset user_message (input panel)
        document.getElementById('input-panel').classList.add('opacity-50');
        document.getElementById('input-status-dot').classList.remove('animate-pulse');
        document.getElementById('input-json-content').innerHTML = '<span class="text-slate-500">// 待機中</span>';
        messageInput.disabled = true;
        messageInput.value = '';
        messageInput.placeholder = 'Startボタンを押してセッションを開始してください';

        // Reset route inputs
        document.getElementById('route-panel').classList.add('opacity-50');
        document.getElementById('route-status').textContent = '(セッション開始後に入力可能)';
        currentLocationInput.value = '';
        currentLocationInput.disabled = true;
        destinationInput.value = '';
        destinationInput.disabled = true;

        // Reset llm_response (output panel)
        outputStatus.textContent = '待機中';
        outputStatusDot.classList.remove('animate-pulse');
        outputJsonContent.innerHTML = '<span class="text-slate-500">// 待機中</span>';

        // Reset session_state display
        const sessionStateJson = document.getElementById('session-state-json');
        sessionStateJson.innerHTML = `<span class="text-slate-500">// 待機中</span>
<span id="session-status" style="display:none">"waiting"</span>
<span id="session-turn" style="display:none">0</span>`;

        // Reset progress indicator
        progressIndicator.textContent = '質問 0/' + maxTurns;

        // Reset Rendered UI (chat container)
        chatContainer.innerHTML = `
            <div class="flex items-center justify-center py-8">
                <div class="text-center">
                    <div class="w-12 h-12 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <p class="text-slate-500 text-sm">待機中</p>
                    <p class="text-slate-600 text-xs mt-1">Startボタンを押してセッションを開始してください</p>
                </div>
            </div>
        `;

        // Reset quick replies
        document.getElementById('quick-replies').innerHTML = '<span class="text-xs text-slate-500">Quick:</span>';

        // Reset voice UI
        if (typeof stopVoiceRecording === 'function') {
            stopVoiceRecording();
        }
        if (transcriptionPanel) {
            transcriptionPanel.classList.add('hidden');
        }
        if (transcriptionText) {
            transcriptionText.innerHTML = '<span class="text-slate-500">音声を入力してください...</span>';
        }
        if (asrStatus) {
            asrStatus.textContent = '待機中';
        }
        if (recordingButton) {
            recordingButton.disabled = true;
            updateRecordingButtonUI(false);
        }
    }

    // Current location input - Enter key handler
    currentLocationInput.addEventListener('keypress', async (e) => {
        if (e.key !== 'Enter') return;
        e.preventDefault();

        if (!isSessionActive) {
            alert('セッションが開始されていません。Startボタンを押してください。');
            return;
        }

        const location = currentLocationInput.value.trim();
        if (!location) return;

        await sendMessageToLLM(location, 'current_location');
    });

    // Destination input - Enter key handler
    destinationInput.addEventListener('keypress', async (e) => {
        if (e.key !== 'Enter') return;
        e.preventDefault();

        if (!isSessionActive) {
            alert('セッションが開始されていません。Startボタンを押してください。');
            return;
        }

        const destination = destinationInput.value.trim();
        if (!destination) return;

        await sendMessageToLLM(destination, 'destination');
    });

    // Common function to send message to LLM
    async function sendMessageToLLM(message, inputType = 'general') {
        // Track the user message
        lastUserMessage = message;

        // Update input display
        updateInputJsonDisplay(message, sessionId, turnCount);

        // Add user message to chat
        addMessage('user', message);

        // Show loading state
        outputStatus.textContent = 'Loading...';
        outputStatusDot.classList.add('animate-pulse');

        const startTime = Date.now();

        try {
            const response = await fetch('/api/v1/chat/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    session_id: sessionId,
                }),
            });

            const duration = Date.now() - startTime;

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // Update turn count
            turnCount = data.turn_count;
            sessionTurn.textContent = turnCount;
            progressIndicator.textContent = `質問 ${turnCount}/${maxTurns}`;

            // Update output JSON display
            updateOutputJson(data);

            // Add AI message to chat
            addMessage('assistant', data.message, data.suggestions);

            // Update quick replies
            updateQuickReplies(data.suggestions);

            // Log API call
            logApiCall('POST', '/api/v1/chat/message', response.status, duration);

            // Update status
            outputStatus.textContent = `${response.status} OK`;
            outputStatusDot.classList.remove('animate-pulse');

            // Update conversation phase and UI based on input type
            if (inputType === 'current_location') {
                conversationPhase = 'asking_destination';
                currentLocationInput.disabled = true;
                destinationInput.disabled = false;
                destinationInput.focus();
            } else if (inputType === 'destination') {
                conversationPhase = 'asking_preferences';
                destinationInput.disabled = true;
                messageInput.disabled = false;
                messageInput.placeholder = '他に行きたいところ・やってみたいことを入力...';
                messageInput.focus();
            } else {
                updateConversationPhase(data);
            }

            // Check if complete
            if (data.is_complete) {
                document.getElementById('session-status').textContent = '"completed"';
                messageInput.placeholder = '会話が完了しました';
            }

            return data;

        } catch (error) {
            console.error('Error:', error);
            outputStatus.textContent = 'Error';
            outputStatusDot.classList.remove('animate-pulse');
            outputStatusDot.classList.remove('bg-emerald-400');
            outputStatusDot.classList.add('bg-red-400');
            logApiCall('POST', '/api/v1/chat/message', 'Error', 0);
            throw error;
        }
    }

    // Update input display when typing
    messageInput.addEventListener('input', (e) => {
        updateInputJsonDisplay(e.target.value, sessionId, turnCount);
    });

    // Quick reply button click handler (dynamic)
    document.getElementById('quick-replies').addEventListener('click', (e) => {
        if (e.target.classList.contains('quick-reply')) {
            messageInput.value = e.target.textContent.trim();
            updateInputJsonDisplay(e.target.textContent.trim(), sessionId, turnCount);
            messageInput.focus();
        }
    });

    // Form submission (for preferences and later messages)
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!isSessionActive) {
            alert('セッションが開始されていません。Startボタンを押してください。');
            return;
        }

        const message = messageInput.value.trim();
        if (!message) return;

        // Disable input during processing
        messageInput.disabled = true;

        try {
            await sendMessageToLLM(message, 'general');
        } catch (error) {
            // Error already handled in sendMessageToLLM
        } finally {
            // Re-enable input
            messageInput.disabled = false;
            messageInput.value = '';
            messageInput.focus();
        }
    });

    // Track last user message for route input updates
    let lastUserMessage = '';

    // Update conversation phase based on response
    function updateConversationPhase(data) {
        const msgLower = data.message.toLowerCase();

        if (msgLower.includes('どこに行きたい')) {
            // User just entered current location, now asking for destination
            currentLocationInput.value = lastUserMessage;
            conversationPhase = 'asking_destination';
            messageInput.placeholder = '目的地を入力してください（例: 横浜駅）';
        } else if (msgLower.includes('他に行きたいところ') || msgLower.includes('やってみたいこと')) {
            // User just entered destination, now asking for preferences
            destinationInput.value = lastUserMessage;
            conversationPhase = 'asking_preferences';
            messageInput.placeholder = '他に行きたいところ・やってみたいことを入力...';
        } else if (data.suggestions && data.suggestions.length > 0) {
            conversationPhase = 'suggesting';
            messageInput.placeholder = '選択肢から選ぶか、追加のリクエストを入力...';
        }
    }

    function addMessage(role, content, suggestions = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-3';

        if (role === 'user') {
            messageDiv.innerHTML = `
                <div class="flex-1 flex justify-end">
                    <div class="bg-blue-500 rounded-2xl rounded-tr-none p-4 max-w-[80%]">
                        <p class="text-sm text-white">${escapeHtml(content)}</p>
                    </div>
                </div>
                <div class="w-8 h-8 bg-slate-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-br from-violet-500 to-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="bg-slate-700 rounded-2xl rounded-tl-none p-4">
                        <p class="text-sm text-slate-200 whitespace-pre-line">${escapeHtml(content)}</p>
                    </div>
                </div>
            `;
        }

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function updateOutputJson(data) {
        const suggestionsStr = data.suggestions.map(s => `<span class="json-string">"${escapeHtml(s)}"</span>`).join(', ');
        const messageStr = escapeHtml(data.message).replace(/\n/g, '\\n');

        outputJsonContent.innerHTML = `<span class="json-key">{</span>
  <span class="json-key">"message"</span>: <span class="json-string">"${messageStr}"</span>,
  <span class="json-key">"suggestions"</span>: [${suggestionsStr}],
  <span class="json-key">"turn_count"</span>: <span class="json-number">${data.turn_count}</span>,
  <span class="json-key">"is_complete"</span>: <span class="json-boolean">${data.is_complete}</span>
<span class="json-key">}</span>`;
    }

    function updateQuickReplies(suggestions) {
        const container = document.getElementById('quick-replies');
        container.innerHTML = '<span class="text-xs text-slate-500">Quick:</span>';

        suggestions.forEach(suggestion => {
            const btn = document.createElement('button');
            btn.className = 'quick-reply px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-full text-xs text-slate-300 transition-colors';
            btn.textContent = suggestion;
            btn.addEventListener('click', () => {
                messageInput.value = suggestion;
                updateInputJsonDisplay(suggestion, sessionId, turnCount);
                messageInput.focus();
            });
            container.appendChild(btn);
        });
    }

    function logApiCall(method, endpoint, status, duration) {
        const logEntry = document.createElement('div');
        logEntry.className = 'p-4 hover:bg-slate-700/50 transition-colors';

        const statusClass = status === 200 || status === '200 OK' ? 'text-emerald-400' : 'text-red-400';
        const now = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        logEntry.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 text-xs font-medium rounded">${method}</span>
                    <span class="mono text-sm text-slate-300">${endpoint}</span>
                </div>
                <div class="flex items-center space-x-4 text-sm">
                    <span class="${statusClass}">${status}</span>
                    <span class="text-slate-500">${duration}ms</span>
                    <span class="text-slate-500 mono text-xs">${now}</span>
                </div>
            </div>
        `;

        // Remove placeholder if exists
        const placeholder = apiLog.querySelector('.text-center');
        if (placeholder) {
            placeholder.remove();
        }

        apiLog.insertBefore(logEntry, apiLog.firstChild);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Clear log button
    document.getElementById('clear-log').addEventListener('click', () => {
        apiLog.innerHTML = `
            <div class="p-4 text-sm text-slate-500 text-center">
                API呼び出しログがここに表示されます
            </div>
        `;
    });

    // Log initial page load
    logApiCall('GET', '/', 200, 0);

    // ========================================
    // Voice Input (WebSocket + Web Audio API)
    // ========================================
    let voiceWs = null;
    let audioContext = null;
    let mediaStream = null;
    let scriptProcessor = null;
    let isRecording = false;

    // Recording button click handler
    recordingButton.addEventListener('click', async () => {
        console.log('Recording button clicked! isSessionActive:', isSessionActive, 'isRecording:', isRecording);
        if (!isSessionActive) {
            alert('セッションが開始されていません。Startボタンを押してください。');
            return;
        }

        if (isRecording) {
            stopVoiceRecording();
        } else {
            await startVoiceRecording();
        }
    });

    // Start voice recording
    async function startVoiceRecording() {
        try {
            // Request microphone access
            mediaStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    sampleRate: 16000,
                    channelCount: 1,
                    echoCancellation: true,
                    noiseSuppression: true,
                }
            });

            // Connect to WebSocket
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/api/v1/ws/voice/${sessionId}`;

            voiceWs = new WebSocket(wsUrl);

            voiceWs.onopen = () => {
                console.log('Voice WebSocket connected');
                asrStatus.textContent = '接続中...';
                logApiCall('WS', `/ws/voice/${sessionId}`, 'Connected', 0);

                // Start ASR
                voiceWs.send(JSON.stringify({ type: 'start_asr' }));
            };

            voiceWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleVoiceMessage(data);
            };

            voiceWs.onerror = (error) => {
                console.error('Voice WebSocket error:', error);
                asrStatus.textContent = 'エラー';
                stopVoiceRecording();
            };

            voiceWs.onclose = () => {
                console.log('Voice WebSocket closed');
                asrStatus.textContent = '切断';
            };

            // Setup audio processing
            audioContext = new (window.AudioContext || window.webkitAudioContext)({
                sampleRate: 16000
            });

            const source = audioContext.createMediaStreamSource(mediaStream);

            // Use ScriptProcessorNode for PCM conversion
            // Buffer size: 4096 samples
            scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

            scriptProcessor.onaudioprocess = (event) => {
                if (!isRecording || !voiceWs || voiceWs.readyState !== WebSocket.OPEN) {
                    return;
                }

                const inputData = event.inputBuffer.getChannelData(0);
                // Convert Float32Array to Int16Array (PCM 16-bit)
                const pcmData = convertFloat32ToInt16(inputData);
                // Send as binary
                voiceWs.send(pcmData.buffer);
            };

            source.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);

            // Update UI
            isRecording = true;
            updateRecordingButtonUI(true);
            transcriptionPanel.classList.remove('hidden');
            transcriptionText.innerHTML = '<span class="text-slate-500">音声を入力してください...</span>';
            asrStatus.textContent = '録音中...';

        } catch (error) {
            console.error('Failed to start voice recording:', error);
            alert('マイクへのアクセスに失敗しました: ' + error.message);
        }
    }

    // Stop voice recording
    function stopVoiceRecording() {
        isRecording = false;

        // Stop audio processing
        if (scriptProcessor) {
            scriptProcessor.disconnect();
            scriptProcessor = null;
        }

        if (audioContext) {
            audioContext.close();
            audioContext = null;
        }

        // Stop media stream
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }

        // Close WebSocket
        if (voiceWs) {
            if (voiceWs.readyState === WebSocket.OPEN) {
                voiceWs.send(JSON.stringify({ type: 'stop_asr' }));
            }
            voiceWs.close();
            voiceWs = null;
        }

        // Update UI
        updateRecordingButtonUI(false);
        asrStatus.textContent = '停止';
    }

    // Handle voice WebSocket messages
    function handleVoiceMessage(data) {
        console.log('Voice message:', data);

        switch (data.type) {
            case 'connected':
                asrStatus.textContent = 'WebSocket接続完了';
                break;

            case 'asr_connected':
                asrStatus.textContent = '音声認識開始';
                break;

            case 'transcription':
                // Display transcription
                if (data.is_final) {
                    transcriptionText.innerHTML = `<span class="text-emerald-400">${escapeHtml(data.text)}</span>`;
                    asrStatus.textContent = '認識完了';

                    // Auto-fill message input
                    if (data.text.trim()) {
                        messageInput.value = data.text.trim();
                        updateInputJsonDisplay(data.text.trim(), sessionId, turnCount);
                    }
                } else {
                    transcriptionText.innerHTML = `<span class="text-slate-300">${escapeHtml(data.text)}</span><span class="animate-pulse">...</span>`;
                    asrStatus.textContent = '認識中...';
                }
                break;

            case 'response':
                // LLM response received
                turnCount = data.turn_count;
                sessionTurn.textContent = turnCount;
                progressIndicator.textContent = `質問 ${turnCount}/${maxTurns}`;

                // Update output JSON display
                updateOutputJson(data);
                outputStatus.textContent = '200 OK';

                // Add messages to chat
                addMessage('user', messageInput.value || transcriptionText.textContent);
                addMessage('assistant', data.message, data.suggestions);

                // Update quick replies
                updateQuickReplies(data.suggestions);

                // Clear message input
                messageInput.value = '';

                // Log API call
                logApiCall('WS', 'voice/response', 'OK', 0);

                // Check if complete
                if (data.is_complete) {
                    document.getElementById('session-status').textContent = '"completed"';
                    messageInput.placeholder = '会話が完了しました';
                    stopVoiceRecording();
                }
                break;

            case 'asr_error':
                asrStatus.textContent = 'ASRエラー';
                transcriptionText.innerHTML = `<span class="text-red-400">エラー: ${escapeHtml(data.message)}</span>`;
                break;

            case 'error':
                asrStatus.textContent = 'エラー';
                transcriptionText.innerHTML = `<span class="text-red-400">エラー: ${escapeHtml(data.message)}</span>`;
                break;

            case 'asr_stopped':
                asrStatus.textContent = '停止';
                break;

            case 'pong':
                // Heartbeat response
                break;

            default:
                console.log('Unknown voice message type:', data.type);
        }
    }

    // Update recording button UI
    function updateRecordingButtonUI(recording) {
        if (recording) {
            // Recording state - show stop button
            recordingButton.classList.remove('bg-violet-500', 'hover:bg-violet-600');
            recordingButton.classList.add('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
            recordingButtonText.textContent = '録音停止';
            micIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>';
        } else {
            // Stopped state - show record button
            recordingButton.classList.add('bg-violet-500', 'hover:bg-violet-600');
            recordingButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
            recordingButtonText.textContent = '録音開始';
            micIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>';
        }
    }

    // Convert Float32 audio samples to Int16 (PCM 16-bit)
    function convertFloat32ToInt16(float32Array) {
        const int16Array = new Int16Array(float32Array.length);
        for (let i = 0; i < float32Array.length; i++) {
            // Clamp to [-1, 1] range
            const s = Math.max(-1, Math.min(1, float32Array[i]));
            // Convert to 16-bit signed integer
            int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return int16Array;
    }

</script>
{% endblock %}
