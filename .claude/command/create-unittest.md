---
description: 単体テストを作成するためのコマンドです。開発エンジニアとして、Pytestを使用してAAAパターンに従った単体テストを作成し、カバレッジ率100%を目標にテストコードを実装します。テスト作成時には不足情報をユーザーに質問し、Given-When-Thenパターンでテストケースを記述します。
allowed-tools:
  - functions.read_file
  - functions.write
  - functions.list_dir
  - functions.glob_file_search
  - functions.search_replace
  - run_terminal_cmd
---

# テスト作成指示

あなたはアプリプリケーションの開発エンジニアです。

## Tasks
以下の要件に従い、単体テストを作成してください。

## 単体テスト（Unit Test）
目的: 開発者がより重要な「どのようなテストケースを検証すべきか」という思考に集中できるようにすること

### テストケース
- プロジェクト下のシステムが機能すること
- 指定コマンドが実行できること
- ユニットがエラー無く実装できていること

### テスト作成時の条件
- テストを作成する際に不足している情報や曖昧な点は、はuserに質問する。
- ユーザー入力をコンテキストとしてテストを作成する。
- ユーザーに "ユーザー指定のツール"について質問して情報を取得してください。
- 質問時はプロジェクトの内容から推察される最適なテストツールの候補を提示してください。

　質問の例：
　```
　テスト作成に使用するツールを選択して下さい。
　1. pytest
  2. jest
  3. Free（30字以内で指定）
  ```
- "ユーザー指定のツール"に関する情報をプロンプトに埋め込んで使用してください。

### プロンプト
```
あなたは熟練したアプリ開発者であなたは単体テストのスペシャリストです。

## Task
以下の関数に対して、**FIRST原則**に基づいた単体テストを作成してください。

{"ユーザー指定のツール"} を使用してカバレッジ付きでテストを実行し、カバレッジ不足を特定して、
カバレッジ率を100%にしてください。
目標はコードカバレッジを100%にすることです。

# Constraints
1. フレームワーク: {"ユーザー指定のツール"}[例: Pytest]
2. モック: 外部通信やDB操作が含まれる場合は、[例: unittest.mock] を使用して完全に隔離してください。
3. テストケース:
   - 正常系 (Happy Path)
   - 境界値 (Edge Cases)
   - 異常系 (Exception Handling)
4. 形式: AAA (Arrange-Act-Assert) 形式で記述してください。

```

### テスト共通の基本パターン
LLMに質の高い単体テストを書かせるために役立つ、基本原則とパターンを整理しました。

**1. 単体テストの基本原則：FIRST**
優れた単体テストが満たすべき5つの指標です。プロンプトに「FIRST原則に従って作成して」と一言添えるだけで、テストの質が向上します。

- Fast (高速): 数百・数千のテストが数秒で終わるべき。
- Independent (独立): 他のテストの結果に依存しない。順不同で実行できる。
- Repeatable (再現可能): 実行環境（時間や場所）に依存せず、常に同じ結果になる。
- Self-Validating (自己検証): 合否が自動で判定される（人がログを目視確認しない）。
- Thorough/Timely (網羅的/タイムリー): 正常系だけでなく、境界値や異常系も網羅する。

**2. 3つの基本パターン**
単体テストを構成する際、以下の3つの切り口を意識すると網羅性が高まります。

① 状態検証 (State Verification)
メソッドを実行した結果、オブジェクトの**「状態（プロパティの値など）」**がどう変化したかを確認します。

例: リストに要素を追加した後、リストのサイズが1増えているか。

② 行動検証 (Behavior Verification / Interaction Testing)
特定のメソッドが**「正しく呼び出されたか」**を確認します。戻り値がない処理や、外部依存がある場合によく使います。

例: ユーザー登録処理の中で、メール送信関数が「1回だけ」「正しいアドレスで」呼ばれたか。

③ 境界値分析 (Boundary Value Analysis)
不具合が発生しやすい**「データの境目」**を重点的にテストします。

例: 「18歳以上が成人」というロジックに対し、17歳、18歳、19歳でテストを行う。

**3. LLMに指示する際の「テストケース選定」の型**
LLMはコードの全行をなぞるテストを書きがちですが、以下のパターンを指定すると、より「意味のある」テストになります。

| パターン名 | 指示のポイント |
|-----------|--------------|
| Happy Path (正常系) | 最も標準的な入力で、期待通りの出力が得られること。 |
| Edge Cases (境界値) | 0, 空文字, NULL, 最大値, 最小値などの特殊な入力。 |
| Error Handling (異常系) | 不正な入力に対して、適切な例外やエラーメッセージを返すか。 |
| Equivalence Partitioning (同値分割) | 同じ結果になるグループから代表値を1つ選んでテストし、無駄を省く。 |


### AAAパターン（Arrange – Act – Assert）
テストは、ほぼこの3ステップに落とし込めます。
テストコードの内部構造は、以下の AAA (Arrange, Act, Assert) 形式で書くと、LLMへの指示もスムーズになり、読みやすさも向上します。

**Arrange（準備）**

- 入力データの用意
- モック / テスト用の環境準備

**Act（実行）**
モック / テスト用の環境準備
- テスト対象の関数やAPIを1回だけ呼ぶ
- 統合テストでは、複数のモジュール間の連携を実際に実行する

**Assert（検証）**

- 戻り値の検証
- 副作用（DBのレコード、呼び出し回数など）を検証
- 統合テストでは、複数のモジュール間の連携結果が正しいことを確認する


| ステップ | 内容 | 具体例 |
|---------|------|--------|
| Arrange (準備) | テストデータの作成、環境構築 | テスト用ユーザーをDBに登録しておく。 |
| Act (実行) | テスト対象の関数やAPIを呼び出す | POST /login にリクエストを送る。 |
| Assert (検証) | 期待通りの結果か確認する | ステータスコードが200か、トークンが返っているか確認する。 |

#### テストのチェックリスト

**単体テストを書くとき**
- テスト対象が1関数/1メソッドに絞られているか
- 外部依存をモックしているか
- AAAパターンで書けているか
- 異常系（エラー、null、空配列など）もテストしているか