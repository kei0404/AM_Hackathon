---
description: 統合テストを作成するためのコマンドです。開発エンジニアとして、複数のモジュール間の連携をテストする統合テストコードを作成します。ユーザーに質問してテストケース、テスト境界、期待するケースの情報を取得し、サンドイッチパターン、API-to-DBパターン、外部サービス・モックパターンなどの基本パターンに従ってAAAパターンでテストコードを実装します。
allowed-tools:
  - functions.read_file
  - functions.write
  - functions.list_dir
  - functions.glob_file_search
  - functions.search_replace
  - run_terminal_cmd
---

# テスト作成指示
あなたはアプリプリケーションの開発エンジニアです。

## Tasks
開発中のアプリケーションの統合テスト用のコードを作成してください。

## テストケース
- userに質問して、テストケースに関する情報を取得する
- user から取得した情報とプロジェクトの内容をコンテキストとする

## テスト作成時の条件
- テストを作成する際に不足している情報や曖昧な点は、はuserに質問する。
- ユーザー入力をコンテキストとしてテストを作成する。
- 質問の際は、以下の3つの内容をユーザーに確認してください。
  Q1. 関連する複数のモジュール（ControllerとService、APIとDBなど）について質問する。
  Q2. どこまでを実機（DBなど）で動かし、どこをモックにするかを明確にして{"テスト境界の情報"}としてプロンプトに埋め込む。
  Q3. 期待するケースをリストアップします。
- コンテキストは **{"ユーザー指定の条件"}**, **{"テスト境界の情報"}**, **{"期待するケース"}** としてプロンプトに埋め込んで下さい。

## プロンプト
```
あなたは熟練したアプリ開発者です。

プロジェクトの内容と要件定義から技術スタックを確認したうえで統合テスト用のコードを作成してください。
開発中のシステムの出力応答を確認するテストコードを作成してください。
プロジェクトの情報と共に、以下の情報も加えてテストを作成してください。

## テスト作成の条件
{"ユーザー指定の条件"} 

## テストの境界（モックの有無）
{"テスト境界の情報"}

## 正常・異常系のパターン
{"期待するケース"}

```

※プロンプトの例
```
あなたは熟練したアプリ開発者です。

フロントエンドがバックエンドのAPIを呼び出す非同期処理のテストコードを生成する。
開発中のシステムの出力応答を確認するテストコードを作成してください。
プロジェクトの情報と共に、以下の情報も加えてテストを作成してください。

## テスト作成の条件
OpenAPI仕様書に基づいて、AサービスからBサービスを呼び出す結合テストのコードを書いてください
```


## 結合テスト（Integration Test）
目的: 以下の点についてテストを実施する

- 層同士のつなぎ目（引数・戻り値・トランザクションなど）が正しく動くか
- 実際のDB・外部サービス（できればテスト用）とちゃんと連携できるか
- モックを減らし、実際の動きに近い形で動かす

#### テスト共通の基本パターン
代表的な3つの基本パターンを整理しました。

**1. サンドイッチパターン（Middle-Out Strategy）**
ターゲットとなる機能を中心に、その「上（呼び出し元）」と「下（呼び出し先）」を結合してテストする最も一般的な手法です。

- 対象: ビジネスロジックを持つサービス層など。
- やり方: * APIコントローラー（上）からの入力を受け取る。
    - データベースや外部API（下）との通信を実際に行う（または本物に近いモックを使う）。
- メリット: ユーザーの操作に近い状態で、ロジックが正しくDBに反映されるかを一気通貫で確認できます。

**2. API-to-DB パターン（Persistence Integration）**
Webアプリケーションの開発で最も多用される、**「APIエンドポイントからデータベースまで」**を繋ぐパターンです。

- 検証内容: * HTTPリクエストが正しくパースされるか。
    - バリデーションを通過し、ビジネスルールが適用されるか。
    - 最終的にDBに期待通りのデータが保存・更新されているか。
- 重要ポイント: テストごとにDBをリセット（クリーンアップ）する処理がセットで必要になります。

**3. 外部サービス・モックパターン（Adapter/Gateway Integration）**
自社システムと外部システム（決済、メール送信、SNSなど）の境界線をテストするパターンです。

- やり方: * 本物の外部APIを叩く代わりに、WireMockや**MSW (Mock Service Worker)**などを使用して、外部からのレスポンスをシミュレートします。
- 検証内容: * 外部サービスがエラー（500や404）を返したときに、自社システムが正しく例外処理を行えるか。
    - リクエストの形式（JSON構造など）が外部の仕様と一致しているか。

**AAAパターン（Arrange – Act – Assert）**
テストは、ほぼこの3ステップに落とし込めます。
テストコードの内部構造は、以下の AAA (Arrange, Act, Assert) 形式で書くと、LLMへの指示もスムーズになり、読みやすさも向上します。

**Arrange（準備）**

- 入力データの用意
- モック / テスト用の環境準備

**Act（実行）**
モック / テスト用の環境準備
- テスト対象の関数やAPIを1回だけ呼ぶ
- 統合テストでは、複数のモジュール間の連携を実際に実行する

**Assert（検証）**

- 戻り値の検証
- 副作用（DBのレコード、呼び出し回数など）を検証
- 統合テストでは、複数のモジュール間の連携結果が正しいことを確認する


| ステップ | 内容 | 具体例 |
|---------|------|--------|
| Arrange (準備) | テストデータの作成、環境構築 | テスト用ユーザーをDBに登録しておく。 |
| Act (実行) | テスト対象の関数やAPIを呼び出す | POST /login にリクエストを送る。 |
| Assert (検証) | 期待通りの結果か確認する | ステータスコードが200か、トークンが返っているか確認する。 |

**Given-When-Then（名前の付け方）**
- Given 条件（前提）
- When 行動（何をしたか）
- Then 結果（どうなるべきか）

#### テストのチェックリスト
**統合テストを書くとき**
- 「どこからどこまでを統合するか」が明確か
- テスト用DB/環境を使っているか
- テストごとに状態をリセットしているか
- 実際のユースケースに近いシナリオになっているか