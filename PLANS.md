# PLANS.md - Data Plug Copilot 実行計画書

**プロジェクト名**: Data Plug Copilot
**バージョン**: 1.3.0
**ライセンス**: 未定（ハッカソン期間中はプライベート）
**最終更新**: 2025-01-17

---

## PLANS.md の使用方法

- 実行可能仕様書（ExecPlan）を作成する際は、PLANS.md を忠実に守ってください。状況に合わない場合は、PLANS.md ファイル全体を読んで記憶を刷新してください。正確な仕様書を作成するには、原資料を徹底的に読み（そして再読し）、仕様書を作成してください。仕様書を作成する際は、骨組みから始めて、調査を進めながら具体化を進めてください。

- 実行可能仕様書（ExecPlan）を実装する際は、ユーザーに「次のステップ」を尋ねず、次のマイルストーンに進んでください。すべてのセクションを最新の状態に保ち、進捗状況と次のステップを明確に示すために、各段階でリストの項目を追加または分割してください。不明瞭な点は自主的に解決し、頻繁にコミットしてください。

- 実行可能仕様書（ExecPlan）について議論する際は、後世のために仕様書のログに決定事項を記録してください。仕様書に変更が加えられた理由が明確に記述されている必要があります。ExecPlan は生きた文書であり、他の作業なしに ExecPlan のみから再開できる必要があります。

- 困難な要件や重大な未知数を含む設計を調査する際には、マイルストーンを用いて概念実証や「トイ実装」などを実施し、ユーザーの提案が実現可能かどうかを検証します。ライブラリのソースコードを探したり入手したりして読み、徹底的に調査し、プロトタイプを組み込むことで、より完全な実装へと導きます。

---

## プロジェクトの目的/全体像

### 概要

Data Plug Copilotは、ユーザーのパーソナルデータ（スケジュール、嗜好、移動履歴、お気に入りスポット）を分析し、AIが目的地を推薦・スケジュールを作成して、そのデータを「プラグイン」として車に接続することで、どの車でも「自分仕様」にパーソナライズできるアプリケーションです。

### コアバリュー

**「車がその瞬間だけあなたのものになる」**

- ユーザーのデータはユーザーのデバイスに残る
- 車はセッション中のみそのデータにアクセス
- セッション終了時に車側のデータは消去される

### 解決する問題

1. **意思決定の負荷**: 運転中・移動中は検索/比較/決定が重く、行き先が固定化しやすい
2. **グループでの合意形成**: 同乗者がいると好みが割れて決まらない
3. **プライバシー懸念**: 共有車時代に「車に個人データを残したくない」心理的ハードル
4. **制約の多さ**: 時間/天候/混雑/駐車/運転負荷など制約が多く、候補の絞り込みが面倒

### 4つの柱

1. **パーソナルデータ**: ユーザーの嗜好、お気に入り、訪問履歴をデバイスに保持
2. **目的地推薦**: AIが最大3回の質問で目的地を絞り込み
3. **スケジュール作成**: AIが最適な訪問順序と時間配分を提案
4. **車へのプラグイン**: セッションベースで車にデータを連携、終了時に消去

---

## 文脈と方向性

### 問題の背景

AMハッカソン（3日間）で開発するMVPプロダクト。Automotive × Human × Generative AI をテーマに、Privacy-by-designなパーソナル車内エージェントを構築する。

### 設計理念

1. **Privacy-by-Design**: データはユーザー側に保持、車はステートレス
2. **決め切る**: 「おすすめ」ではなく「決定」まで導く（最大3問）
3. **合意形成**: 同乗者全員が納得できる候補を提示
4. **安全第一**: 運転中は最小操作（Yes/No・3択中心）

### 主な制約

- **期間**: 3日間でMVP完成
- **物理デバイス**: 物理ドングルは作らない（QR=論理プラグイン）
- **地図アプリ**: 地図アプリは作らない（ピンレイヤーのみ）
- **90秒デモ**: デモシナリオを最優先で実装

### 現在の状態

- **フェーズ**: MVP実装中（データフローダッシュボード完成）
- **要件定義**: `specs/001-navi-schedule/spec.md` (v2.3.0)
- **品質チェック**: `specs/001-navi-schedule/checklists/requirements.md` (全項目パス)
- **技術スタック**: FastAPI + Jinja2テンプレート（Python統一環境）**実装完了**
- **Web UI**: データフロー可視化ダッシュボード **動作確認済み**
- **LLM連携**: デモモード実装済み（APIキー設定で本番モード切替可）

### キーファイル

| ファイル | 説明 |
|----------|------|
| `/specs/001-navi-schedule/spec.md` | 要件定義書 v2.3.0 |
| `/specs/001-navi-schedule/checklists/requirements.md` | 品質チェックリスト |
| `/docs/DataPlug_Copilot_Development_Plan.md` | 開発計画書 |
| `/docs/Data Plug_Copilot_PRD.md` | PRD（製品要件定義） |
| `/docs/designs/ver02/dashboard-dataflow.html` | データフローダッシュボードデザイン |
| `/src/backend/templates/dashboard.html` | ダッシュボードテンプレート（実装） |
| `/src/backend/main.py` | FastAPIメインアプリケーション |
| `/CLAUDE.md` | Claude Code用プロジェクト設定 |
| `/.specify/memory/constitution.md` | コーディング規約 |

---

## 仕様

### システム仕様

#### アーキテクチャ概要

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   スマートフォン   │────▶│   バックエンド    │────▶│   車載デバイス    │
│  (データ保持)     │◀────│   (LLM/API)     │◀────│  (セッション中)   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                                              │
        │              QRコード/近接通信                │
        └──────────────────────────────────────────────┘
```

#### コンポーネント構成

1. **スマートフォンUI（FastAPI + Jinja2テンプレート）**
   - パーソナルデータ管理UI
   - 同意・スコープ選択UI
   - 同乗者入力UI（2問）
   - ピン追加UI
   - **技術**: FastAPI + Jinja2 + Tailwind CSS（SSR）

2. **車載UI（FastAPI + Jinja2テンプレート）**
   - QRコード表示
   - 3問の質問UI
   - 候補3つの表示
   - 決定・ルート開始
   - セッション終了・破棄表示
   - **技術**: FastAPI + Jinja2 + Tailwind CSS（SSR）

3. **バックエンド・API（FastAPI統合）**
   - セッション管理
   - LLM呼び出し（目的地推薦、スケジュール作成、合意形成説明）
   - ストレージ（JSON可）
   - HTML UI配信（Jinja2テンプレート）
   - **技術**: Python + FastAPI + Pydantic + Jinja2

### データフロー

1. 車でQR表示 → スマホで読み取り（論理プラグイン）
2. スマホでデータスコープ同意（必要最小限）
3. セッションキー発行 → 車はセッション中のみ参照
4. 車内で短い質問（最大3問） → 候補提示 → 1つに決定
5. セッション終了 → 車側キャッシュ破棄（UIで明示）
6. 訪問結果/ピン追加はユーザー側ストレージに保存

### 主要エンティティ

| エンティティ | 説明 | 保存場所 |
|-------------|------|----------|
| パーソナルデータ | 嗜好、お気に入り、履歴 | ユーザーデバイス |
| 嗜好設定 | ジャンル、雰囲気、価格帯 | ユーザーデバイス |
| お気に入りスポット | 場所名、住所、メモ | ユーザーデバイス |
| 訪問履歴 | 訪問日時、滞在時間 | ユーザーデバイス |
| スケジュール | 目的地リスト、時刻 | セッション中のみ |
| セッション | 接続状態、共有範囲 | 揮発性 |

---

## 目標とする成果物

### MVP成果物（3日間）

1. **スマートフォンUI（Web）**
   - 同意・スコープ選択画面
   - 同乗者入力画面（2問）
   - パーソナルデータ管理画面
   - ピン追加画面

2. **車載UI（Web）**
   - QRコード表示画面
   - 3問の質問画面
   - 候補3つの表示画面
   - 決定・確認画面
   - セッション終了・破棄確認画面

3. **バックエンドAPI**
   - セッション管理API
   - 目的地推薦API（LLM連携）
   - スケジュール作成API（LLM連携）
   - グループ合意形成API（LLM連携）

4. **90秒デモシナリオ**
   - 動作するデモフロー

### 成功基準（spec.mdより抜粋）

| ID | 基準 | 目標値 |
|----|------|--------|
| SC-001 | 最大3回の質問で目的地決定 | 100% |
| SC-004 | 同乗者の嗜好入力時間 | 30秒/人以内 |
| SC-007 | スケジュールが営業時間内 | 95% |
| SC-010 | セッション開始時間 | 15秒以内 |
| SC-011 | データ消去完了時間 | 5秒以内 |

---

## 進捗

### マイルストーン

- [x] M0: プロジェクト初期設定
- [x] M1: 要件定義完了（spec.md v2.0.0）
- [x] M2: 品質チェック完了
- [x] M3: PLANS.md作成
- [x] M4: 技術スタック決定・環境構築 ← **完了（FastAPI + Jinja2統合）**
- [x] M5: バックエンドAPI実装（FastAPI） ← **完了（Chat API、セッション管理）**
- [x] M6: データフローダッシュボードUI実装 ← **完了（入出力可視化）**
- [ ] M7: 車載UI実装（Jinja2テンプレート）
- [x] M8: LLM連携実装（Qwen API） ← **完了（デモモード付き）**
- [ ] M9: 統合テスト
- [ ] M10: 90秒デモ完成

### 詳細タスク

#### 完了タスク
- [x] 要件定義書作成（v1.0.0）
- [x] PRD情報の統合（v1.1.0）
- [x] パーソナルデータ駆動型にリファクタリング（v2.0.0）
- [x] 技術制約追加（v2.1.0 - FastAPI, Next.js）
- [x] Webアプリ開発方針確定（v2.2.0）
- [x] フロントエンドもFastAPIで統合（v2.3.0）
- [x] 品質チェックリスト作成・検証
- [x] PLANS.md作成
- [x] 技術スタック決定（FastAPI + Jinja2統合）
- [x] Python仮想環境構築（.venv）
- [x] requirements.txt作成・依存関係インストール
- [x] バックエンド基本構造作成（src/backend/）
- [x] LLMサービス実装（Qwen API連携）
- [x] 会話サービス実装（セッション管理）
- [x] Chat API実装
- [x] CLIテストツール作成
- [x] **Jinja2テンプレート環境構築**
- [x] **ベーステンプレート作成（base.html）**
- [x] **データフローダッシュボードテンプレート作成（dashboard.html）**
- [x] **Webルーター実装（api/web.py）**
- [x] **LLMデモモード実装（APIキーなしでも動作）**
- [x] **リアルタイムJSON表示機能**
- [x] **APIコールログ表示機能**

#### 残存タスク
- [ ] 目的地推薦機能の強化
- [ ] スケジュール作成機能実装
- [ ] グループ合意形成機能実装
- [ ] 車載UI実装（Jinja2テンプレート）
- [ ] QRコード表示機能
- [ ] セッション終了・データ消去UI
- [ ] 統合テスト
- [ ] デモシナリオ作成
- [ ] デモ動画撮影

**最終更新**: 2025-01-17 18:55

---

## 驚きと発見

> 実装中に発見された予期せぬ挙動、バグ、洞察を記録する

### 発見1: 要件定義のスコープ変更

**日付**: 2025-01-17
**内容**: 当初のタクシードライバー向け機能（SNSトレンド連携、会話ファシリテーション）から、一般ユーザー向けのパーソナルデータ駆動型に方向転換。

**証拠**:
```
旧: Trend Stock（SNS外部データ）を使用
新: ユーザーのパーソナルデータのみに焦点化
```

**影響**: 外部API依存が減り、MVPとしてはシンプルになった。

### 発見2: 技術スタックの決定

**日付**: 2025-01-17
**内容**: バックエンドにFastAPI、フロントエンドにNext.jsを採用することが決定。

**根拠**:
```
FastAPI: 高速非同期処理、自動APIドキュメント、型安全性、LLM APIとの親和性
Next.js: React基盤のSSR/SSG、優れたDX、Tailwind CSSとの統合容易
```

**影響**: 開発環境の構築が開始され、バックエンドの基本構造が作成された。

### 発見3: フロントエンドのFastAPI統合

**日付**: 2025-01-17
**内容**: フロントエンドもFastAPI + Jinja2テンプレートで統合することに決定。Next.jsは不採用。

**根拠**:
```
FastAPI + Jinja2:
- Python統一環境によるシンプルな開発
- サーバーサイドレンダリング（SSR）
- 3日間MVPに適した軽量構成
- 追加のNode.js環境不要
```

**影響**: プロジェクト構造がシンプルになり、Python単一言語で開発可能に。

### 発見4: データフロー可視化ダッシュボードの実装

**日付**: 2025-01-17
**内容**: spec.md v2.3.0の「どんな情報を受け取り、どんな情報を返しているか」が明確にわかるUIを実装。

**実装内容**:
```
- 左カラム: INPUT（user_preferences, favorite_spots, user_message）をJSON形式で表示
- 右カラム: OUTPUT（llm_response, session_state）をJSON形式で表示
- リアルタイム更新: 入力時にJSONが即座に更新
- APIコールログ: エンドポイント、ステータス、レスポンスタイムを表示
- デモモード: APIキーがなくても固定レスポンスで動作確認可能
```

**影響**: MVPデモで「データの流れ」を明確に可視化できるようになった。

---

## 決定ログ

| 日付 | 決定事項 | 根拠 | トレードオフ |
|------|----------|------|--------------|
| 2025-01-17 | パーソナルデータ駆動型に変更 | ユーザー指示、MVPの焦点明確化 | SNSトレンド機能は削除 |
| 2025-01-17 | タクシードライバー向け機能削除 | 一般ユーザーに焦点化 | 法人向け展開は将来課題 |
| 2025-01-17 | QRコード＝論理プラグイン | 物理ドングル不要でMVP期間に適合 | NFC等は将来課題 |
| 2025-01-17 | **バックエンド: FastAPI** | 高速非同期、自動APIドキュメント、型安全性、LLM APIとの親和性 | Python限定 |
| 2025-01-17 | ~~フロントエンド: Next.js~~ → **Jinja2に変更** | 当初はNext.jsを予定 | v2.3.0で変更 |
| 2025-01-17 | **Webアプリとして開発** | モバイルアプリではなくブラウザベース | ネイティブ機能は利用不可 |
| 2025-01-17 | **フロントエンド: FastAPI + Jinja2** | Python統一環境、シンプル構成、3日間MVPに最適 | SPAではなくSSR |
| 2025-01-17 | **LLM: Qwen (DashScope)** | 既存APIキー利用可能、日本語対応 | 他LLMへの切り替えが必要な場合あり |
| 2025-01-17 | **データフロー可視化ダッシュボード** | spec.md v2.3.0のMVP UI方針に準拠 | 洗練されたデザインより機能重視 |
| 2025-01-17 | **LLMデモモード実装** | APIキーなしでも動作確認可能 | 固定レスポンスのため実際のAI応答ではない |

---

## 作業計画

### Phase 1: 環境構築（Day 1前半）✅ 完了

1. **技術スタック決定** ✅
   - フロントエンド & バックエンド: **Python + FastAPI + Jinja2**（統合環境）
   - LLM: **Qwen (DashScope API)**
   - ストレージ: JSON（MVP）
   - スタイリング: **Tailwind CSS**（CDN経由）

2. **プロジェクト構造** ✅ **完了**
   ```
   /
   ├── src/
   │   └── backend/           # FastAPI バックエンド + フロントエンド ✅
   │       ├── api/           # APIエンドポイント ✅
   │       │   ├── chat.py    # Chat API ✅
   │       │   └── web.py     # Webページルーター ✅
   │       ├── services/      # ビジネスロジック ✅
   │       │   ├── llm_service.py        # LLM連携 ✅
   │       │   └── conversation_service.py # 会話管理 ✅
   │       ├── models/        # Pydanticデータモデル ✅
   │       │   └── chat.py    # チャットモデル ✅
   │       ├── templates/     # Jinja2テンプレート ✅
   │       │   ├── base.html      # ベーステンプレート ✅
   │       │   └── dashboard.html # データフローダッシュボード ✅
   │       ├── static/        # 静的ファイル ✅
   │       ├── config.py      # 設定 ✅
   │       └── main.py        # FastAPIアプリ ✅
   ├── scripts/               # テストスクリプト ✅
   │   └── chat_cli.py        # チャットCLI ✅
   ├── docs/designs/          # UIデザイン ✅
   │   ├── ver01/             # 初期デザイン
   │   └── ver02/             # データフロー可視化デザイン ✅
   ├── .venv/                 # Python仮想環境 ✅
   ├── requirements.txt       # Python依存関係 ✅
   └── .env                   # 環境変数 ✅
   ```

### Phase 2: バックエンド実装（Day 1後半〜Day 2前半）

1. **データモデル実装**
   - `models/personal_data.py`: パーソナルデータ
   - `models/session.py`: セッション管理
   - `models/recommendation.py`: 推薦結果

2. **API実装**
   - `POST /sessions`: セッション開始
   - `DELETE /sessions/{id}`: セッション終了
   - `POST /recommendations`: 目的地推薦
   - `POST /schedules`: スケジュール作成
   - `POST /group-consensus`: グループ合意形成

3. **LLM連携**
   - プロンプトテンプレート作成
   - 3問での絞り込みロジック
   - 合意形成説明生成

### Phase 3: フロントエンド実装（Day 2後半〜Day 3前半）

**技術**: FastAPI + Jinja2テンプレート + Tailwind CSS（SSR）

1. **スマートフォンUI（Jinja2テンプレート）**
   - 同意・スコープ選択画面
   - 同乗者入力画面
   - パーソナルデータ管理画面
   - **MVP UI方針**: データフローが見えるUI（受け取り/返却データの可視化）

2. **車載UI（Jinja2テンプレート）**
   - QRコード表示画面
   - 質問・回答画面
   - 候補表示画面
   - セッション終了画面
   - **MVP UI方針**: データフローが見えるUI（受け取り/返却データの可視化）

### Phase 4: 統合・デモ（Day 3後半）

1. **統合テスト**
   - エンドツーエンドフロー確認
   - エッジケース確認

2. **90秒デモ**
   - デモシナリオ最終確認
   - デモ動画撮影

---

## 作業の具体的なステップと内容

### Step 1: プロジェクト初期化 ✅ 完了

**作業ディレクトリ**: `/Users/katsumikatano/projects/AM_Huckathon`

```bash
# Python環境構築 ✅ 完了
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# requirements.txt の内容:
# fastapi>=0.109.0
# uvicorn[standard]>=0.27.0
# openai>=1.12.0  # Qwen API用
# python-dotenv>=1.0.0
# pydantic>=2.5.0
# pytest>=7.4.0
# jinja2>=3.1.0  # Jinja2テンプレート用（追加予定）

# ※ Next.jsは不採用（v2.3.0でFastAPI + Jinja2に統合決定）
```

**実行結果**:
```
Successfully installed fastapi-0.128.0 uvicorn-0.40.0 openai-2.15.0 pydantic-2.12.5 ...
```

### Step 2: データモデル作成

**ファイル**: `src/backend/models/personal_data.py`

```python
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

class Preference(BaseModel):
    genres: List[str]  # カフェ、レストラン、自然など
    atmosphere: str    # 静か、賑やか
    price_range: str   # 低、中、高

class FavoriteSpot(BaseModel):
    name: str
    address: str
    latitude: float
    longitude: float
    category: str
    memo: Optional[str]
    added_at: datetime

class PersonalData(BaseModel):
    user_id: str
    preferences: Preference
    favorite_spots: List[FavoriteSpot]
    visit_history: List[dict]
```

### Step 3: セッション管理API作成

**ファイル**: `src/backend/api/sessions.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import List
import uuid

router = APIRouter()

class SessionCreate(BaseModel):
    user_id: str
    scope: List[str]  # "schedule", "favorites", "all"

class Session(BaseModel):
    session_id: str
    user_id: str
    scope: List[str]
    status: str  # "active", "ended"

@router.post("/sessions", response_model=Session)
def create_session(data: SessionCreate):
    # セッション作成ロジック
    pass

@router.delete("/sessions/{session_id}")
def end_session(session_id: str):
    # セッション終了・データ消去ロジック
    pass
```

---

## 未解決の質問

### Q1: LLMの選定 ✅ 解決済み

**決定**: Qwen (DashScope API) を使用

**根拠**:
- APIキーが既に `.env` に設定済み（DASHSCOPE_API_KEY）
- 日本語対応品質が良好
- OpenAI互換のAPIインターフェース

**実装状況**: `src/backend/config.py` で設定読み込み実装済み

### Q2: デプロイ環境

**状況**: MVPのデプロイ先を決定する必要がある。

**選択肢**:
- A: ローカル開発環境のみ
- B: Vercel（フロント）+ Railway（バック）
- C: AWS/GCP

**阻害要因**: 設定時間、コスト

### Q3: 車載UIの表示方法

**状況**: 実際の車載デバイスがないため、代替手段を検討。

**選択肢**:
- A: タブレット + Web表示
- B: PC + フルスクリーンブラウザ
- C: シミュレーター

---

## 成果と振り返り

> プロジェクト完了後に記入

### 達成されたこと

- [ ] 90秒デモの完成
- [ ] MVP全機能の実装
- [ ] 要件定義の全項目達成

### 課題

（実装後に記入）

### 教訓

（実装後に記入）

---

## 検証と受け入れ

### システム起動方法

```bash
# アプリケーション起動（FastAPI統合環境）
source .venv/bin/activate
uvicorn src.backend.main:app --reload --port 8000

# アクセス先:
# → http://localhost:8000 （Webアプリ - Jinja2テンプレート）
# → http://localhost:8000/docs （Swagger UI - APIドキュメント）
# → http://localhost:8000/redoc （ReDoc - APIドキュメント）

# CLIテスト
python scripts/chat_cli.py
```

### 観察すべき動作

1. スマートフォンでQRコードをスキャンするとセッションが開始される
2. スコープ選択画面が表示される
3. 車載UIで3問の質問が表示される
4. 候補3つが理由付きで表示される
5. 1つ選択するとルート案内が開始される
6. セッション終了時に「データ消去完了」が表示される

### テスト可能な受け入れ基準

| ID | 基準 | 検証方法 |
|----|------|----------|
| AC-001 | 3問以内で目的地が決定する | 質問回数をカウント |
| AC-002 | 同乗者入力が30秒以内に完了 | ストップウォッチで計測 |
| AC-003 | セッション終了後にデータが残らない | 車載UI再読み込みで確認 |
| AC-004 | 推薦理由が表示される | 画面に理由テキストがある |
| AC-005 | 複数同乗者の希望が反映される | 各候補に「誰の希望を満たすか」表示 |

### テストシナリオ

**シナリオ1: 単独ユーザーの目的地決定**
1. スマホでQRスキャン
2. 「お気に入り」スコープを選択
3. 車載UIで「今日どこか行きたい」と入力
4. 3問の質問に回答
5. 候補3つから1つを選択
6. セッション終了

**シナリオ2: グループでの合意形成**
1. ドライバーがセッション開始
2. 同乗者2名がスマホで嗜好入力（各2問）
3. 車載UIで候補3つと「誰の何を満たすか」を確認
4. グループで1つを選択
5. セッション終了

### 成功指標

- [ ] 90秒デモが途切れずに完了する
- [ ] ハッカソン審査員に価値が伝わる
- [ ] 全ての受け入れ基準を満たす

---

## 更新履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|------------|----------|------|
| 2025-01-17 | 1.0.0 | 初版作成 | Claude |
| 2025-01-17 | 1.1.0 | spec.md v2.1.0に合わせて更新（技術スタック決定: FastAPI + Next.js） | Claude |
| 2025-01-17 | 1.2.0 | spec.md v2.3.0に合わせて更新（フロントエンドをFastAPI + Jinja2に変更、Python統一環境） | Claude |
| 2025-01-17 | 1.3.0 | データフローダッシュボード実装完了、LLMデモモード追加、プロジェクト構造更新 | Claude |

---

## 参照ドキュメント

- [要件定義書](./specs/001-navi-schedule/spec.md)
- [品質チェックリスト](./specs/001-navi-schedule/checklists/requirements.md)
- [開発計画書](./docs/DataPlug_Copilot_Development_Plan.md)
- [PRD](./docs/Data%20Plug_Copilot_PRD.md)
- [コーディング規約](./.specify/memory/constitution.md)
